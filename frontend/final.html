<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 3: The Endgame</title>
    <link rel="stylesheet" href="../static/css/main.css">
    <style>
        .final-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            padding: 2rem;
            background: radial-gradient(circle at center, rgba(196, 30, 58, 0.4) 0%, rgba(0, 0, 0, 1) 90%);
        }

        .power-symbol {
            font-size: 8rem;
            color: var(--accent-avengers);
            text-shadow: 0 0 50px var(--accent-avengers), 0 0 100px var(--accent-red-bright);
            margin-bottom: 2rem;
            animation: pulse 3s infinite ease-in-out;
        }

        @keyframes pulse {

            0%,
            100% {
                text-shadow: 0 0 30px var(--accent-avengers), 0 0 60px var(--accent-red-bright);
                transform: scale(1);
            }

            50% {
                text-shadow: 0 0 80px var(--accent-avengers), 0 0 120px var(--accent-red-bright), 0 0 20px white;
                transform: scale(1.1);
            }
        }

        /* Modal Overrides */
        .power-modal {
            border-color: var(--accent-avengers);
            box-shadow: 0 0 50px var(--accent-avengers), 0 0 100px rgba(196, 30, 58, 0.5);
            background: rgba(10, 10, 10, 0.95);
        }

        .timer-display {
            font-size: 4rem;
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-avengers);
            text-shadow: 0 0 20px var(--accent-avengers);
            margin: 2rem 0;
            padding: 1rem 3rem;
            background: rgba(196, 30, 58, 0.1);
            border: 2px solid var(--accent-avengers);
            border-radius: 12px;
            letter-spacing: 4px;
        }

        .timer-display.warning {
            color: var(--accent-red-bright);
            text-shadow: 0 0 40px var(--accent-red-bright);
            animation: pulse 0.5s infinite;
            border-color: var(--accent-red-bright);
        }

        .challenge-active {
            display: none;
        }

        .challenge-active.show {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .timeout-message {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
        }

        .timeout-message.show {
            display: flex;
        }

        .lock-icon {
            font-size: 5rem;
            color: var(--accent-red-bright);
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>

    <div class="final-container">
        <!-- Initial State -->
        <div id="initial-state">
            <div class="power-symbol">‚ö°</div>
            <h1 class="cinematic-title animate-on-scroll">THE FINAL WAR</h1>
            <p style="font-size: 1.5rem; color: var(--text-secondary); margin-bottom: 3rem; max-width: 600px;">
                You have gathered the infinity stones.<br>
                One final challenge remains before the snap.
            </p>

            <button onclick="openStep1()" class="btn-cyber interactive"
                style="border-color: var(--accent-avengers); color: white;">ENTER FINAL CHALLENGE</button>
        </div>

        <!-- Challenge Active State (no timer) -->
        <div id="challenge-active" class="challenge-active">
            <div class="power-symbol" style="font-size: 4rem;">‚ö°</div>
            <h1 class="cinematic-title">FINAL BATTLE</h1>
            <p style="font-size: 1.2rem; color: var(--text-secondary); margin-bottom: 2rem;">
                The multiverse is at stake.<br>Complete the challenge on HackerRank.
            </p>

            <div style="margin-top: 2rem;">
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">Complete the challenge on HackerRank:</p>
                <a href="https://www.hackerrank.com/codeverse-csi" target="_blank" class="btn-cyber interactive">
                    OPEN HACKERRANK
                </a>
            </div>
            
            <div style="margin-top: 2rem;">
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">After completing the challenge, click below to submit:</p>
                <button onclick="completePhase3()" class="btn-cyber interactive" style="border-color: var(--accent-avengers);">
                    COMPLETE PHASE 3
                </button>
            </div>
        </div>
    </div>

    <!-- Step 1: Ready Confirmation Modal -->
    <div id="modal-step-1" class="modal-overlay">
        <div class="glass-card power-modal animate-on-scroll" style="text-align: center; max-width: 600px;">
            <h2 class="cinematic-title" style="color: var(--accent-avengers); font-size: 2.5rem;">‚ö†Ô∏è Final Challenge
                Ahead</h2>
            <div style="margin: 2rem 0; font-size: 1.2rem; line-height: 1.6; color: var(--text-primary);">
                <p>You are about to enter the final round of CodeVerse.</p>
                <p style="margin-top: 1rem;">Complete the challenge on HackerRank and submit your results.</p>
                <p style="margin-top: 1rem; color: var(--accent-red-bright);">Once you complete Phase 3, all scores will be revealed.
                </p>
            </div>
            <div style="display: flex; gap: 1.5rem; justify-content: center; margin-top: 2rem;">
                <button onclick="closeStep1()" class="btn-cyber interactive" style="border-color: #555;">‚ùå Not
                    Now</button>
                <button onclick="proceedToStep2()" class="btn-cyber interactive"
                    style="border-color: var(--accent-avengers); background: rgba(0, 255, 0, 0.1);">‚úÖ I'm Ready</button>
            </div>
        </div>
    </div>

    <!-- Step 2: Endgame Engage Modal -->
    <div id="modal-step-2" class="modal-overlay">
        <div class="glass-card power-modal animate-on-scroll" style="text-align: center; max-width: 600px;">
            <h2 class="cinematic-title" style="color: var(--accent-red-bright); font-size: 2.5rem;">üü• The Endgame
                Begins</h2>
            <div style="margin: 2rem 0; font-size: 1.2rem; line-height: 1.6; color: var(--text-primary);">
                <p>This is your final battle.</p>
                <p style="margin-top: 1rem;">Complete the challenge on HackerRank at your own pace.</p>
                <p style="margin-top: 1rem; font-style: italic;">After completion, return here to submit and reveal your scores.</p>
            </div>
            <div style="display: flex; gap: 1.5rem; justify-content: center; margin-top: 2rem;">
                <button onclick="closeStep2()" class="btn-cyber interactive" style="border-color: #555;">‚¨ÖÔ∏è Go
                    Back</button>
                <button onclick="engageEndgame()" class="btn-cyber interactive"
                    style="background: rgba(196,30,58,0.4); border-color: var(--accent-red-bright);">üî• Enter Final
                    Challenge</button>
            </div>
        </div>
    </div>

    <script src="../static/js/cursor.js"></script>
    <script src="../static/js/animations.js"></script>
    <script src="../static/js/state-manager.js"></script>
    <script>
        // DOM Elements
        const initialState = document.getElementById('initial-state');
        const challengeActive = document.getElementById('challenge-active');

        const modal1 = document.getElementById('modal-step-1');
        const modal2 = document.getElementById('modal-step-2');

        // Constants & Config
        const HACKERRANK_URL = 'https://www.hackerrank.com/codeverse-csi';

        // --- Flow Control ---

        function openStep1() {
            modal1.classList.add('active');
        }

        function closeStep1() {
            modal1.classList.remove('active');
        }

        function proceedToStep2() {
            closeStep1();
            modal2.classList.add('active');
        }

        function closeStep2() {
            modal2.classList.remove('active');
        }

        function engageEndgame() {
            // Show confirmation dialog before redirecting to HackerRank
            const confirmed = confirm('Are you ready to proceed to HackerRank?\n\nClick OK to continue or Cancel to stay on this page.');
            
            if (!confirmed) {
                return; // User cancelled, don't proceed
            }
            
            // 1. Close Modal
            closeStep2();

            // 2. Show active state
            initialState.style.display = 'none';
            challengeActive.classList.add('show');

            // 3. Redirect to HackerRank
            window.open(HACKERRANK_URL, '_blank');
        }

        async function completePhase3() {
            // Show confirmation
            const confirmed = confirm('Have you completed the HackerRank challenge? Once you submit, your scores will be revealed.\n\nClick OK to submit or Cancel to continue.');
            
            if (!confirmed) {
                return;
            }
            
            // Get score from user (in real implementation, this would come from HackerRank API)
            const scoreInput = prompt('Enter your Phase 3 score (0-100):');
            const score = parseInt(scoreInput);
            
            if (isNaN(score) || score < 0 || score > 100) {
                alert('Invalid score. Please enter a number between 0 and 100.');
                return;
            }
            
            try {
                const response = await fetch('/api/complete-phase-3', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ points: score })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Phase 3 completed! Your scores are now visible.');
                    window.location.href = 'score.html';
                } else {
                    alert('Failed to complete Phase 3: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error completing Phase 3:', error);
                alert('Error completing Phase 3. Please try again.');
            }
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check if Phase 3 is already in progress
            // Show active state if user has already started
            initialState.style.display = 'block';
            challengeActive.classList.remove('show');
        });

    </script>
</body>

</html>