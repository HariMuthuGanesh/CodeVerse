<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 2: Time Stone - DSA Challenges</title>
    <link rel="stylesheet" href="../static/css/main.css">
    <style>
        .dsa-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }

        /* HUD & Timer */
        .hud-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1000px;
            margin-bottom: 2rem;
            padding: 1rem 2rem;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--accent-avengers);
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }

        .timer-display {
            font-size: 2rem;
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-avengers);
            text-shadow: 0 0 10px var(--accent-avengers);
        }

        .timer-display.warning {
            color: var(--accent-red-bright);
            animation: pulse 1s infinite;
        }

        .score-display,
        .question-display {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--text-primary);
        }

        .challenge-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .challenge-tab {
            padding: 1rem 2rem;
            background: rgba(196, 30, 58, 0.1);
            border: 2px solid var(--accent-avengers);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Orbitron', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .challenge-tab.active {
            background: rgba(196, 30, 58, 0.4);
            box-shadow: 0 0 20px var(--accent-avengers);
        }

        .challenge-content {
            display: none;
            width: 100%;
            max-width: 1000px;
            flex-direction: column;
            align-items: center;
        }

        .challenge-content.active {
            display: flex;
        }

        /* BST Game UI */
        .bst-viz-container {
            width: 100%;
            height: 500px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--accent-avengers);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            padding-top: 40px;
        }

        /* Control Area */
        .controls-area {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            width: 100%;
            justify-content: center;
        }

        .btn-action {
            padding: 0.5rem 1.5rem;
            background: transparent;
            border: 1px solid var(--accent-avengers);
            color: var(--accent-avengers);
            font-family: 'Orbitron';
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-action:hover {
            background: var(--accent-avengers);
            color: white;
        }

        /* Drag & Drop Areas */
        .bank-container {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 2px solid var(--accent-avengers);
            margin-bottom: 2rem;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            flex-wrap: wrap;
            justify-content: center;
            min-height: 80px;
            /* Ensure drop target if empty */
        }

        .draggable {
            width: 50px;
            height: 50px;
            background: var(--accent-avengers);
            color: #fff;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 0 10px var(--accent-avengers);
            font-family: 'Orbitron';
            z-index: 10;
        }

        .draggable.dragging {
            opacity: 0.5;
        }

        .dropzone {
            width: 60px;
            height: 60px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s;
            background: rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .dropzone.hovered {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.1);
        }

        /* Modals */
        #loading-overlay {
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-avengers);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Tree Layout Lines */
        .tree-level {
            display: flex;
            justify-content: center;
            gap: 2rem;
            position: relative;
            margin-bottom: 2rem;
        }

        /* Specific gaps for perfect binary tree look */
        .level-1 {
            gap: 0;
        }

        .level-2 {
            gap: 12rem;
        }

        .level-3 {
            gap: 2rem;
        }

        .connector-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: -30px;
            /* Adjust based on gap */
            pointer-events: none;
            z-index: 0;
        }
    </style>
</head>

<body>

    <div class="dsa-container">
        <!-- HUD PANEL -->
        <div class="hud-panel">
            <div class="score-display" id="score-display">Phase 2 Score: 0</div>
            <div class="timer-display" id="phase2-timer">10:00</div>
            <div>
                <button class="btn-action" onclick="pauseGame()"
                    style="border-color: #FFA500; color: #FFA500; margin-right: 1rem;">PAUSE</button>
                <button class="btn-action" onclick="finishRound()" style="border-color: #FF0000; color: #FF0000;">FINISH
                    ROUND</button>
            </div>
        </div>

        <h2 class="cinematic-title" style="color: var(--accent-avengers); margin-bottom: 0.5rem;">PHASE 2: TIME STONE
        </h2>
        <p style="color: grey; margin-bottom: 2rem;">Manage the Timeline. Pause to save time. Finish to lock score.</p>

        <!-- Challenge Tabs -->
        <div class="challenge-tabs">
            <button class="challenge-tab active" onclick="showChallenge('bst')" id="tab-bst">
                Binary Search Tree
            </button>
            <button class="challenge-tab" onclick="showChallenge('rb')" id="tab-rb">
                Red-Black Tree
            </button>
            <button class="challenge-tab" onclick="showChallenge('detective')" id="tab-detective">
                Tree Detective (Extra)
            </button>
        </div>

        <!-- BST CHALLENGE UI -->
        <div id="challenge-bst" class="challenge-content active">
            <div
                style="background: rgba(0,0,0,0.5); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align:center;">
                <h3>Hard BST Challenge</h3>
                <p>Drag numbers to build a valid Binary Search Tree.<br>
                    <span style="color: grey; font-size: 0.9em;">Rule: Left < Parent < Right. Deep violations are
                            checked!</span>
                </p>
                <p style="color:#FFA500; font-size:0.8em; margin-top:5px;">Warning: Partial solutions score ZERO.</p>
            </div>

            <!-- Draggable Bank -->
            <div class="bank-container" id="bst-bank">
                <!-- Hardcoded values for the BST Challenge -->
                <div class="draggable" draggable="true" data-value="50" id="node-50">50</div>
                <div class="draggable" draggable="true" data-value="30" id="node-30">30</div>
                <div class="draggable" draggable="true" data-value="70" id="node-70">70</div>
                <div class="draggable" draggable="true" data-value="20" id="node-20">20</div>
                <div class="draggable" draggable="true" data-value="40" id="node-40">40</div>
                <div class="draggable" draggable="true" data-value="60" id="node-60">60</div>
                <div class="draggable" draggable="true" data-value="80" id="node-80">80</div>
            </div>

            <!-- Fixed Tree Slots -->
            <div style="display:flex; flex-direction:column; align-items:center;">
                <!-- Level 1 (Root) -->
                <div class="tree-level level-1">
                    <div class="dropzone" id="bst-slot-1" data-index="1"></div>
                </div>

                <!-- Connectors Level 1-2 -->
                <svg width="400" height="40" style="margin-top:-10px; margin-bottom:10px;">
                    <line x1="200" y1="0" x2="100" y2="40" stroke="rgba(255,255,255,0.3)" stroke-width="2" />
                    <line x1="200" y1="0" x2="300" y2="40" stroke="rgba(255,255,255,0.3)" stroke-width="2" />
                </svg>

                <!-- Level 2 -->
                <div class="tree-level level-2" style="gap: 12rem;">
                    <div class="dropzone" id="bst-slot-2" data-index="2"></div>
                    <div class="dropzone" id="bst-slot-3" data-index="3"></div>
                </div>

                <!-- Connectors Level 2-3 -->
                <div style="display:flex; gap:6rem; justify-content:center; width:100%;">
                    <svg width="200" height="40" style="margin-top:-10px; margin-bottom:10px;">
                        <line x1="100" y1="0" x2="50" y2="40" stroke="rgba(255,255,255,0.3)" stroke-width="2" />
                        <line x1="100" y1="0" x2="150" y2="40" stroke="rgba(255,255,255,0.3)" stroke-width="2" />
                    </svg>
                    <svg width="200" height="40" style="margin-top:-10px; margin-bottom:10px;">
                        <line x1="100" y1="0" x2="50" y2="40" stroke="rgba(255,255,255,0.3)" stroke-width="2" />
                        <line x1="100" y1="0" x2="150" y2="40" stroke="rgba(255,255,255,0.3)" stroke-width="2" />
                    </svg>
                </div>

                <!-- Level 3 -->
                <div class="tree-level level-3" style="gap: 6rem;">
                    <div style="display:flex; gap:2rem;">
                        <div class="dropzone" id="bst-slot-4" data-index="4"></div>
                        <div class="dropzone" id="bst-slot-5" data-index="5"></div>
                    </div>
                    <div style="display:flex; gap:2rem;">
                        <div class="dropzone" id="bst-slot-6" data-index="6"></div>
                        <div class="dropzone" id="bst-slot-7" data-index="7"></div>
                    </div>
                </div>
            </div>

            <button class="btn-action" onclick="validateBST()" style="margin-top: 2rem;">VALIDATE & SUBMIT BST</button>
        </div>

        <!-- RED-BLACK CHALLENGE UI (Legacy Support) -->
        <div id="challenge-rb" class="challenge-content">
            <div style="background: rgba(0,0,0,0.5); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <h3>Red-Black Tree Challenge</h3>
                <p>Color the nodes and place them correctly. Root must be BLACK. No Red-Red relationships.</p>
            </div>

            <div class="bank-container" id="rb-bank">
                <!-- Nodes populated by JS -->
                <div class="draggable" draggable="true" data-value="10" data-color="black"
                    style="background:black; border:2px solid var(--accent-avengers);">10</div>
                <div class="draggable" draggable="true" data-value="5" data-color="red"
                    style="background:#D00; border:2px solid white;">5</div>
                <div class="draggable" draggable="true" data-value="15" data-color="red"
                    style="background:#D00; border:2px solid white;">15</div>
                <div class="draggable" draggable="true" data-value="2" data-color="black"
                    style="background:black; border:2px solid var(--accent-avengers);">2</div>
                <div class="draggable" draggable="true" data-value="7" data-color="black"
                    style="background:black; border:2px solid var(--accent-avengers);">7</div>
                <div class="draggable" draggable="true" data-value="12" data-color="black"
                    style="background:black; border:2px solid var(--accent-avengers);">12</div>
                <div class="draggable" draggable="true" data-value="20" data-color="black"
                    style="background:black; border:2px solid var(--accent-avengers);">20</div>
            </div>

            <!-- Hardcoded Tree Slots for RB -->
            <div style="display:flex; flex-direction:column; align-items:center; gap:2rem;">
                <div class="dropzone" id="rb-slot-1"></div>
                <div style="display:flex; gap:8rem;">
                    <div class="dropzone" id="rb-slot-2"></div>
                    <div class="dropzone" id="rb-slot-3"></div>
                </div>
                <div style="display:flex; gap:2rem;">
                    <div class="dropzone" id="rb-slot-4"></div>
                    <div class="dropzone" id="rb-slot-5"></div>
                    <div class="dropzone" id="rb-slot-6"></div>
                    <div class="dropzone" id="rb-slot-7"></div>
                </div>
            </div>

            <button class="btn-action" onclick="validateRB()" style="margin-top: 2rem;">VALIDATE RB TREE</button>
        </div>

        <!-- TREE DETECTIVE CHALLENGE UI -->
        <div id="challenge-detective" class="challenge-content">
            <div
                style="background: rgba(0,0,0,0.5); padding: 1rem; border-radius: 8px; margin-bottom: 2rem; text-align:center;">
                <h3>Tree Detective (Hard)</h3>
                <p>This BST has been sabotaged! Swap the nodes to fix the violations.<br>
                    <span style="color: grey; font-size: 0.9em;">Look for <strong>DEEP VIOLATIONS</strong> (Valid
                        locally, Invalid globally).</span>
                </p>
                <div style="margin-top: 10px;">
                    <span
                        style="border: 1px solid var(--accent-avengers); padding: 5px; border-radius: 4px; font-size: 0.8em; color: var(--accent-avengers);">Hint:
                        Left < Parent < Right</span>
                </div>
            </div>

            <!-- Detective Bank (For holding/swapping) -->
            <div class="bank-container" id="detective-bank" style="min-height: 80px; justify-content:center;">
                <p style="color: #666; font-size: 0.8rem; align-self: center;">Drag nodes here temporarily if needed</p>
            </div>

            <!-- Fixed Tree Slots for Detective -->
            <div style="display:flex; flex-direction:column; align-items:center;">
                <!-- Level 1 (Root) -->
                <div class="tree-level level-1">
                    <div class="dropzone" id="detective-slot-1" data-index="1"></div>
                </div>

                <!-- Connectors Level 1-2 -->
                <svg width="400" height="40" style="margin-top:-10px; margin-bottom:10px;">
                    <line x1="200" y1="0" x2="100" y2="40" stroke="rgba(255,255,255,0.3)" stroke-width="2" />
                    <line x1="200" y1="0" x2="300" y2="40" stroke="rgba(255,255,255,0.3)" stroke-width="2" />
                </svg>

                <!-- Level 2 -->
                <div class="tree-level level-2" style="gap: 12rem;">
                    <div class="dropzone" id="detective-slot-2" data-index="2"></div>
                    <div class="dropzone" id="detective-slot-3" data-index="3"></div>
                </div>

                <!-- Connectors Level 2-3 -->
                <div style="display:flex; gap:6rem; justify-content:center; width:100%;">
                    <svg width="200" height="40" style="margin-top:-10px; margin-bottom:10px;">
                        <line x1="100" y1="0" x2="50" y2="40" stroke="rgba(255,255,255,0.3)" stroke-width="2" />
                        <line x1="100" y1="0" x2="150" y2="40" stroke="rgba(255,255,255,0.3)" stroke-width="2" />
                    </svg>
                    <svg width="200" height="40" style="margin-top:-10px; margin-bottom:10px;">
                        <line x1="100" y1="0" x2="50" y2="40" stroke="rgba(255,255,255,0.3)" stroke-width="2" />
                        <line x1="100" y1="0" x2="150" y2="40" stroke="rgba(255,255,255,0.3)" stroke-width="2" />
                    </svg>
                </div>

                <!-- Level 3 -->
                <div class="tree-level level-3" style="gap: 6rem;">
                    <div style="display:flex; gap:2rem;">
                        <div class="dropzone" id="detective-slot-4" data-index="4"></div>
                        <div class="dropzone" id="detective-slot-5" data-index="5"></div>
                    </div>
                    <div style="display:flex; gap:2rem;">
                        <div class="dropzone" id="detective-slot-6" data-index="6"></div>
                        <div class="dropzone" id="detective-slot-7" data-index="7"></div>
                    </div>
                </div>
            </div>

            <button class="btn-action" onclick="validateDetective()" style="margin-top: 2rem;">VALIDATE & FIX</button>
        </div>

    </div>

    <!-- Result Modal -->
    <div id="result-modal" class="modal-overlay">
        <div class="glass-card" style="text-align:center; padding: 3rem; border-color: var(--accent-avengers);">
            <h2 id="result-title" class="cinematic-title"></h2>
            <p id="result-msg" style="margin: 2rem 0; font-size: 1.2rem;"></p>
            <div id="action-area"></div>
        </div>
    </div>

    <!-- Confirm Exit Modal -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="glass-card" style="text-align:center; padding: 3rem; border-color: var(--accent-red-bright);">
            <h2 class="cinematic-title" style="color:var(--accent-red-bright)">CONFIRM EXIT</h2>
            <p style="margin: 2rem 0; font-size: 1.2rem;">Are you sure you want to finish the round?</p>
            <p style="color: grey;">Your current score will be locked. You cannot return.</p>
            <div style="display:flex; gap:1rem; justify-content:center; margin-top:2rem;">
                <button class="btn-action" onclick="closeConfirm()"
                    style="border-color:white; color:white;">CANCEL</button>
                <button class="btn-action" onclick="confirmExit()"
                    style="background:var(--accent-red-bright); color:black; font-weight:bold;">CONFIRM FINISH</button>
            </div>
        </div>
    </div>

    <!-- Pause Modal -->
    <div id="pause-modal" class="modal-overlay">
        <div class="glass-card" style="text-align:center; padding: 3rem; border-color: var(--accent-avengers);">
            <h2 class="cinematic-title" style="color:var(--accent-avengers)">GAME PAUSED</h2>
            <p style="margin: 2rem 0; font-size: 1.2rem;">Timeline Frozen.</p>
            <div style="display:flex; gap:1rem; justify-content:center; margin-top:2rem;">
                <button class="btn-action" onclick="resumeGame()"
                    style="border-color:white; color:white;">RESUME</button>
                <button class="btn-action" onclick="saveAndExit()"
                    style="background:var(--accent-avengers); color:black; font-weight:bold;">SAVE & EXIT</button>
            </div>
        </div>
    </div>

    <script src="../static/js/cursor.js"></script>
    <script src="../static/js/state-manager.js"></script>
    <script src="../static/js/dsa-trees.js"></script>
    <script src="../static/js/dsa.js"></script>
</body>

</html>